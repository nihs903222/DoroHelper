name: Sync DoroHelper Releases to BaiduYun

on:
  schedule:
    - cron: "0 */6 * * *"  # æ¯ 6 å°æ™‚æª¢æŸ¥ä¸€æ¬¡ï¼ˆUTC æ™‚é–“ï¼‰
  workflow_dispatch:       # å¯æ‰‹å‹•è§¸ç™¼

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: å®‰è£å·¥å…·
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl unzip

      - name: ä¸‹è¼‰æœ€æ–° release
        run: |
          mkdir -p releases
          # å–å¾—æœ€æ–° release tag
          latest_tag=$(curl -s https://api.github.com/repos/1204244136/DoroHelper/releases/latest | jq -r .tag_name)
          echo "$latest_tag" > latest_tag.txt
          echo "æœ€æ–°ç‰ˆæœ¬: $latest_tag"

          # å»ºç«‹æœ¬åœ°ç‰ˆæœ¬è³‡æ–™å¤¾
          mkdir -p releases/$latest_tag

          # ä¸‹è¼‰ release è³‡ç”¢
          assets=$(curl -s https://api.github.com/repos/1204244136/DoroHelper/releases/tags/$latest_tag | jq -r '.assets[].browser_download_url')
          for url in $assets; do
            echo "â¬‡ï¸ ä¸‹è¼‰ $url"
            curl -L "$url" -o "releases/$latest_tag/$(basename $url)"
          done

      - name: å®‰è£ BaiduPCS-Go
        run: |
          wget -q https://github.com/qjfoidnh/BaiduPCS-Go/releases/download/v3.9.3/BaiduPCS-Go-v3.9.3-linux-amd64.zip
          unzip -q BaiduPCS-Go-v3.9.3-linux-amd64.zip
          chmod +x BaiduPCS-Go-v3.9.3-linux-amd64/BaiduPCS-Go
          sudo mv BaiduPCS-Go-v3.9.3-linux-amd64/BaiduPCS-Go /usr/local/bin/

      - name: é…ç½®ç™¾åº¦é›²ç™»å…¥
        run: |
          export BDUSS="${{ secrets.BAIDU_BDUSS }}"
          echo "âœ… å·²è¨­å®š BDUSS"


      - name: ä¸Šå‚³è‡³ç™¾åº¦é›²
        run: |
          export BDUSS="${{ secrets.BAIDU_BDUSS }}"
          TAG=$(cat latest_tag.txt)
          echo "ğŸ“‚ ç¢ºä¿ç›®éŒ„ /Doro_Helper/$TAG å­˜åœ¨"
          BaiduPCS-Go mkdir "/Doro_Helper/$TAG"
      
          echo "â¬†ï¸ ä¸Šå‚³ç‰ˆæœ¬ $TAG..."
          BaiduPCS-Go upload "releases/$TAG" "/Doro_Helper/$TAG"


          
      - name: ä¸Šå‚³è‡³ç™¾åº¦é›²
        run: |
          TAG=$(cat latest_tag.txt)
          echo "ğŸ“‚ ç¢ºä¿ç›®éŒ„ /Doro_Helper/$TAG å­˜åœ¨"
          BaiduPCS-Go mkdir "/Doro_Helper/$TAG"
        
          # ä¸Šå‚³æ•´å€‹ release è³‡æ–™å¤¾
          echo "â¬†ï¸ ä¸Šå‚³ç‰ˆæœ¬ $TAG..."
          BaiduPCS-Go upload "releases/$TAG" "/Doro_Helper/$TAG/"


      - name: æ¸…ç†èˆŠç‰ˆæœ¬ï¼ˆä¿ç•™æœ€è¿‘ä¸‰å€‹ï¼‰
        run: |
          echo "ğŸ§¹ æ¸…ç†èˆŠç‰ˆæœ¬ï¼Œåªä¿ç•™æœ€è¿‘ä¸‰å€‹"
          # å–å¾—ç¾æœ‰ç‰ˆæœ¬è³‡æ–™å¤¾åˆ—è¡¨ï¼Œæ’åºå¾Œä¿ç•™å‰ä¸‰å€‹
          list=$(BaiduPCS-Go ls /Doro_Helper | awk '{print $NF}' | sort -r | tail -n +4)
          for old in $list; do
            echo "åˆªé™¤èˆŠç‰ˆæœ¬ï¼š$old"
            BaiduPCS-Go rm -r "/Doro_Helper/$old"
          done
